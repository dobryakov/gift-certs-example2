<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Definitions_GiftCertificateLifecycle"
                  targetNamespace="http://company.example/gift-certificates">
  <bpmn:process id="Process_GiftCertificateLifecycle" isExecutable="false">
    <bpmn:laneSet id="LaneSet_1">
      <bpmn:lane id="Lane_InternetStore" name="Internet Store">
        <bpmn:flowNodeRef>StartEvent_OrderCreated</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_SendIssueCommand</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>EndEvent_OrderComplete</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_GCP" name="Сервис Процессинга Подарочных Сертификатов">
        <bpmn:flowNodeRef>Task_ValidateCommand</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ExclusiveGateway_ChannelCheck</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_GenerateCertificate</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_RequestPaymentFix</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_PublishEvents</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_Payments" name="Payments">
        <bpmn:flowNodeRef>Task_FixPayment</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_CRM" name="CRM">
        <bpmn:flowNodeRef>Task_SendCVC</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_BI" name="BI Platform">
        <bpmn:flowNodeRef>Task_ConsumeAudit</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>

    <bpmn:startEvent id="StartEvent_OrderCreated" name="Заказ оформлен">
      <bpmn:outgoing>Flow_Start_To_Command</bpmn:outgoing>
    </bpmn:startEvent>

    <bpmn:task id="Task_SendIssueCommand" name="Отправить команду issueCertificate">
      <bpmn:incoming>Flow_Start_To_Command</bpmn:incoming>
      <bpmn:outgoing>Flow_Command_To_Validate</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Start_To_Command" sourceRef="StartEvent_OrderCreated" targetRef="Task_SendIssueCommand"/>

    <bpmn:task id="Task_ValidateCommand" name="Провести бизнес-валидацию">
      <bpmn:incoming>Flow_Command_To_Validate</bpmn:incoming>
      <bpmn:outgoing>Flow_Validate_To_Gateway</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Command_To_Validate" sourceRef="Task_SendIssueCommand" targetRef="Task_ValidateCommand"/>

    <bpmn:exclusiveGateway id="ExclusiveGateway_ChannelCheck" name="Канал разрешён?">
      <bpmn:incoming>Flow_Validate_To_Gateway</bpmn:incoming>
      <bpmn:outgoing>Flow_Gateway_To_Generate</bpmn:outgoing>
      <bpmn:outgoing>Flow_Gateway_To_End</bpmn:outgoing>
    </bpmn:exclusiveGateway>

    <bpmn:sequenceFlow id="Flow_Validate_To_Gateway" sourceRef="Task_ValidateCommand" targetRef="ExclusiveGateway_ChannelCheck"/>

    <bpmn:task id="Task_GenerateCertificate" name="Создать сертификат и CVC">
      <bpmn:incoming>Flow_Gateway_To_Generate</bpmn:incoming>
      <bpmn:outgoing>Flow_Generate_To_FixPayment</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Gateway_To_Generate" sourceRef="ExclusiveGateway_ChannelCheck" targetRef="Task_GenerateCertificate"/>

    <bpmn:task id="Task_RequestPaymentFix" name="Запросить фиксацию платежа">
      <bpmn:incoming>Flow_Generate_To_FixPayment</bpmn:incoming>
      <bpmn:outgoing>Flow_Request_To_FixPayment</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Generate_To_FixPayment" sourceRef="Task_GenerateCertificate" targetRef="Task_RequestPaymentFix"/>

    <bpmn:task id="Task_FixPayment" name="Зафиксировать платёж">
      <bpmn:incoming>Flow_Request_To_FixPayment</bpmn:incoming>
      <bpmn:outgoing>Flow_FixPayment_To_Publish</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Request_To_FixPayment" sourceRef="Task_RequestPaymentFix" targetRef="Task_FixPayment"/>

    <bpmn:task id="Task_PublishEvents" name="Опубликовать события выпуска">
      <bpmn:incoming>Flow_FixPayment_To_Publish</bpmn:incoming>
      <bpmn:outgoing>Flow_Publish_To_CRM</bpmn:outgoing>
      <bpmn:outgoing>Flow_Publish_To_BI</bpmn:outgoing>
      <bpmn:outgoing>Flow_Publish_To_End</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_FixPayment_To_Publish" sourceRef="Task_FixPayment" targetRef="Task_PublishEvents"/>

    <bpmn:task id="Task_SendCVC" name="Отправить CVC клиенту">
      <bpmn:incoming>Flow_Publish_To_CRM</bpmn:incoming>
      <bpmn:outgoing>Flow_CRM_To_End</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Publish_To_CRM" sourceRef="Task_PublishEvents" targetRef="Task_SendCVC"/>

    <bpmn:task id="Task_ConsumeAudit" name="Принять событие Audit">
      <bpmn:incoming>Flow_Publish_To_BI</bpmn:incoming>
      <bpmn:outgoing>Flow_BI_To_End</bpmn:outgoing>
    </bpmn:task>

    <bpmn:sequenceFlow id="Flow_Publish_To_BI" sourceRef="Task_PublishEvents" targetRef="Task_ConsumeAudit"/>

    <bpmn:endEvent id="EndEvent_ChannelRejected" name="Канал отклонён">
      <bpmn:incoming>Flow_Gateway_To_End</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_Gateway_To_End" sourceRef="ExclusiveGateway_ChannelCheck" targetRef="EndEvent_ChannelRejected"/>

    <bpmn:endEvent id="EndEvent_OrderComplete" name="Заказ завершён">
      <bpmn:incoming>Flow_Publish_To_End</bpmn:incoming>
      <bpmn:incoming>Flow_CRM_To_End</bpmn:incoming>
      <bpmn:incoming>Flow_BI_To_End</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_Publish_To_End" sourceRef="Task_PublishEvents" targetRef="EndEvent_OrderComplete"/>
    <bpmn:sequenceFlow id="Flow_CRM_To_End" sourceRef="Task_SendCVC" targetRef="EndEvent_OrderComplete"/>
    <bpmn:sequenceFlow id="Flow_BI_To_End" sourceRef="Task_ConsumeAudit" targetRef="EndEvent_OrderComplete"/>
  </bpmn:process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_GiftCertificateLifecycle">
    <bpmndi:BPMNPlane id="BPMNPlane_GiftCertificateLifecycle" bpmnElement="Process_GiftCertificateLifecycle">
      <bpmndi:BPMNLane id="BPMNLane_InternetStore" bpmnElement="Lane_InternetStore">
        <dc:Bounds x="0" y="0" width="400" height="120"/>
      </bpmndi:BPMNLane>
      <bpmndi:BPMNLane id="BPMNLane_GCP" bpmnElement="Lane_GCP">
        <dc:Bounds x="0" y="120" width="400" height="180"/>
      </bpmndi:BPMNLane>
      <bpmndi:BPMNLane id="BPMNLane_Payments" bpmnElement="Lane_Payments">
        <dc:Bounds x="0" y="300" width="400" height="100"/>
      </bpmndi:BPMNLane>
      <bpmndi:BPMNLane id="BPMNLane_CRM" bpmnElement="Lane_CRM">
        <dc:Bounds x="0" y="400" width="400" height="100"/>
      </bpmndi:BPMNLane>
      <bpmndi:BPMNLane id="BPMNLane_BI" bpmnElement="Lane_BI">
        <dc:Bounds x="0" y="500" width="400" height="100"/>
      </bpmndi:BPMNLane>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>

