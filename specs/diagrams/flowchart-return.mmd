%% Mermaid flowchart: процесс возврата подарочного сертификата
flowchart TD
    A[Start: запрос возврата сертификата] --> B{Канал соответствует сертификату?}
    B -- Нет --> X[Отказать и уведомить канал]
    B -- Да --> C[Проверить статус сертификата]
    C -->|Активен или частично списан| D[Рассчитать сумму возврата]
    C -->|Уже погашен полностью| X
    D --> E{Можно ли вернуть на исходное платёжное средство?}
    E -- Да --> F[Отправить команду в Payments]
    F --> G[Получить подтверждение All_Payments]
    E -- Нет --> H[Запросить реквизиты у клиента]
    H --> I[Зафиксировать pending_refund_details]
    I --> F
    G --> J[Обновить статус сертификата (refunded)]
    J --> K[Публиковать событие GiftCertificates.*]
    K --> L[Логировать в GiftCertificate.Audit]
    L --> M[End]

