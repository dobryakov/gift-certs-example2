%% Mermaid flowchart: процесс возврата подарочного сертификата
flowchart TD
    A[Start: запрос возврата сертификата] --> B{Канал соответствует сертификату?}
    B -- Нет --> X[Отказать и уведомить канал]
    B -- Да --> C[Проверить статус сертификата]
    C -->|Активен или частично списан| D[Рассчитать сумму возврата]
    C -->|Уже погашен полностью| X
    D --> E{Можно ли вернуть на исходное платёжное средство?}
    E -- Да --> F[Опубликовать событие возврата в All_Payments]
    E -- Нет --> H[Запросить реквизиты у клиента]
    H --> I[Обновить pending_refund_details]
    I --> F
    F --> G[Опубликовать обновление заказа в All_SalesOrder]
    G --> J[Сервис процессинга фиксирует refund]
    J --> K[Публикация GiftCertificates.Stream (статус REFUND_PENDING/REFUNDED)]
    K --> L[BI и CRM обрабатывают новое состояние]
    L --> M[End]

