%% Mermaid sequence diagram: частичное списание подарочного сертификата в оффлайн-канале
sequenceDiagram
    participant Customer
    participant POS
    participant GCP as Gift Certificate Processing
    participant Orders as All_SalesOrder
    participant Payments as All_Payments
    participant BI

    Customer->>POS: Покупка товара с сертификатом
    POS->>Orders: Событие заказа с позицией оплаты сертификатом
    POS->>Payments: Событие платежа (partial capture)
    Orders-->>GCP: Событие заказа
    Payments-->>GCP: Событие платежа
    GCP->>GCP: Пересчёт остатка сертификата
    GCP-->>POS: Событие GiftCertificates.Stream {eventType=redeem.partial}
    GCP-->>BI: Событие GiftCertificates.Stream {eventType=redeem.partial}
    GCP-->>Orders: Enriched событие (через GiftCertificates.Stream, metadata link)

