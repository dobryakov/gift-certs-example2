%% Mermaid sequence diagram: покупка подарочного сертификата в онлайн-канале
sequenceDiagram
    participant Customer
    participant IM as Internet Store
    participant GCP as Gift Certificate Processing
    participant Orders as All_SalesOrder
    participant Payments as All_Payments
    participant CRM
    participant BI

    Customer->>IM: Оформление заказа на сертификат
    IM->>GCP: HTTP GET /certificates/next?channel=ONLINE
    GCP-->>IM: Следующий сертификат (id, CVC token)
    IM->>Orders: Публикация события заказа (ссылки на сертификат)
    IM->>Payments: Публикация события авторизации платежа
    Orders-->>GCP: Событие заказа
    Payments-->>GCP: Событие платежа (approved)
    GCP->>GCP: Обновление состояния сертификата
    GCP-->>IM: Событие GiftCertificates.Stream {eventType=issued}
    GCP-->>CRM: Событие GiftCertificates.Stream {eventType=notification.requested}
    CRM->>GCP: HTTP GET /certificates/{id}/cvc
    GCP-->>CRM: CVC в защищённом ответе
    CRM-->>Customer: Отправка CVC (email/SMS)
    GCP-->>BI: Событие GiftCertificates.Stream {eventType=issued}

