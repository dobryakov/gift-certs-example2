%% Mermaid diagram: архитектура взаимодействия сервисов и Kafka-топиков
flowchart LR
    subgraph OnlineChannel["Онлайн канал (ИМ)"]
        IM["Internet Store"]
    end
    subgraph OfflineChannel["Оффлайн канал (POS)"]
        POS["POS"]
    end
    subgraph CoreServices["Корпоративные сервисы"]
        GCP["Сервис Процессинга Подарочных Сертификатов"]
        ORD["Orders"]
        PAY["Payments"]
        CRM["CRM"]
    end
    BI["BI Platform"]
    Customer["Customer"]

    IM -- "HTTP\nGET /certificates/next" --> GCP
    POS -- "HTTP\nGET /certificates/next" --> GCP

    IM -- "publish\nAll_SalesOrder" --> ORD
    POS -- "publish\nAll_SalesOrder" --> ORD
    ORD -- "forward\nAll_SalesOrder" --> GCP
    ORD -- "forward\nAll_SalesOrder" --> BI

    IM -- "publish\nAll_Payments" --> PAY
    POS -- "publish\nAll_Payments" --> PAY
    PAY -- "forward\nAll_Payments" --> GCP
    PAY -- "forward\nAll_Payments" --> BI

    CRM -- "publish\nAll_Clients" --> GCP
    CRM -- "publish\nAll_Clients" --> BI

    GCP -- "publish\nGiftCertificates.Stream\n(GiftCertificate state)" --> IM
    GCP -- "publish\nGiftCertificates.Stream\n(GiftCertificate state)" --> POS
    GCP -- "publish\nGiftCertificates.Stream\n(GiftCertificate state)" --> CRM
    GCP -- "publish\nGiftCertificates.Stream\n(GiftCertificate state)" --> BI

    CRM -- "HTTP\nGET /certificates/{id}/cvc" --> GCP
    CRM -- "send CVC\n(письмо/SMS)" --> Customer
