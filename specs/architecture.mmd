flowchart LR
  subgraph Channels
    A[OnlineStore]
    B[POS]
  end

  subgraph Core
    GC[GiftCertificateProcessing]
    BL[GiftCertificateBatchLoader]
    PAY[Payments]
    ORD[Orders]
    CRM[CRM]
  end

  BI[BI Pipeline]
  SMS[SMS Gateway]

  Kafka{{Kafka}}

  A -- authorize/capture/refund --> GC
  B -- authorize/capture/refund --> GC
  BL -- batch upload --> GC
  PAY -- All_Payments (certificateAllocations) --> Kafka
  ORD -- All_SalesOrder (certificateLines) --> Kafka
  CRM -- All_Clients --> Kafka

  Kafka -- All_SalesOrder --> GC
  Kafka -- All_Payments --> GC
  Kafka -- GiftCertificateTransaction --> BI
  Kafka -- GiftCertificateBI --> BI

  GC -- GiftCertificateState --> Kafka
  GC -- GiftCertificateTransaction --> Kafka
  GC -- GiftCertificateBI --> Kafka
  GC -- RefundInitiated --> PAY
  GC -- SMS CVC --> SMS
  GC -- баланс/статус --> A
  GC -- баланс/статус --> B
