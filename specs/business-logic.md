# Перечень ключевых событий бизнес-логики

## 1. Оформление заказа на подарочный сертификат

- **Что происходит:** Покупатель оформляет заказ на подарочный сертификат в интернет-магазине или POS.
- **Последствия:**
  - HTTP-запрос из канала (`Internet Store` или `POS`) в платёжный сервис `Payments` на авторизацию платежа.
  - После успешной авторизации канал публикует команду `issueCertificate` в Kafka-топик `GiftCertificate.Commands`.

## 2. Выпуск (issue) сертификата

- **Что происходит:** Сервис процессинга получает команду `issueCertificate`, генерирует сертификат, присваивает номер и CVC.
- **Последствия:**
  - Внутренний HTTP-запрос в `Payments` на фиксацию платежа (capture) по авторизации.
  - Публикация события в `GiftCertificates.State` с атрибутами `status=ISSUED`, `channel` и деталями сертификата.
  - Публикация события в `GiftCertificate.Notifications` для CRM с инструкцией отправить CVC клиенту.
  - Запись события аудита в `GiftCertificate.Audit`.

## 3. Отправка CVC покупателю

- **Что происходит:** CRM получает событие из `GiftCertificate.Notifications` и отправляет CVC.
- **Последствия:**
  - Отправка email/SMS клиенту с данными сертификата.
  - Обновление CRM-профиля клиента, добавление записи о коммуникации.
  - При необходимости публикация обновлённого состояния клиента в `All_Clients`.

## 4. Частичное списание (redeemPartial)

- **Что происходит:** Клиент оплачивает покупку, частично используя сертификат.
- **Последствия:**
  - Канал (POS или ИМ) отправляет команду `redeemPartial` в `GiftCertificate.Commands`.
  - HTTP-запрос GCP Service в Orders для привязки заказа к сертификату.
  - Запрос в Payments на доплату оставшейся суммы (если требуется).
  - Публикация события в `GiftCertificates.State` с `status=PARTIALLY_REDEEMED`, указанием редукции баланса.
  - Запись события аудита в `GiftCertificate.Audit`.
  - Enriched событие заказа в `All_SalesOrder`.

## 5. Полное списание (redeemFull)

- **Что происходит:** Сертификат полностью погашается при оплате.
- **Последствия:**
  - Команда `redeemFull` в `GiftCertificate.Commands`.
  - HTTP-запрос в Orders на фиксацию оплаты сертификатом.
  - Публикация события в `GiftCertificates.State` с `status=REDEEMED`, `remainingBalance=0`.
  - Аудит-событие в `GiftCertificate.Audit`.
  - Обновление `All_SalesOrder` с указанием закрытого сертификата.

## 6. Возврат (refund) сертификата

- **Что происходит:** Клиент запрашивает возврат средств по сертификату.
- **Последствия:**
  - Команда `refund` от канала в `GiftCertificate.Commands`.
  - HTTP-запрос в Payments: если возможно, возврат на исходный платёжный метод.
  - При отказе — генерация запроса на дополнительные реквизиты (обновление поля `pendingRefundDetails`).
  - Публикация события `GiftCertificates.State` со статусом `REFUNDED` (или `REFUND_PENDING`).
  - Запись в `GiftCertificate.Audit`.
  - Публикация события в `All_Payments` об операции возврата.

## 7. Блокировка сертификата (lock)

- **Что происходит:** Служба поддержки вручную блокирует сертификат для проверки.
- **Последствия:**
  - HTTP-вызов на эндпоинт `/certificates/{id}/actions/lock`.
  - Обновление состояния в хранилище GCP Service, фиксация статуса `LOCKED`.
  - Публикация события `GiftCertificates.State` с соответствующим статусом и причиной.
  - Аудит-событие в `GiftCertificate.Audit`.

## 8. Разблокировка сертификата (unlock)

- **Что происходит:** Завершена проверка, сертификат снова доступен.
- **Последствия:**
  - HTTP-вызов `/certificates/{id}/actions/unlock` (FUTURE).
  - Обновление статуса в хранилище и событие `GiftCertificates.State` с предыдущим бизнес-статусом.
  - Аудит-запись о снятии блокировки.

## 9. Актуализация данных для BI

- **Что происходит:** BI подписывается на события и формирует витрины.
- **Последствия:**
  - Потребление `GiftCertificates.State`, `GiftCertificate.Audit`, `All_SalesOrder`, `All_Payments`, `All_Clients`.
  - Загрузка данных в витрины и отчёты, обновление агрегатов и метрик (осуществляется без дополнительных HTTP-вызовов).
