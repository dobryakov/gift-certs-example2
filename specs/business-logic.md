# Перечень ключевых событий бизнес-логики

## 1. Оформление заказа на подарочный сертификат

- **Что происходит:** Покупатель оформляет заказ на подарочный сертификат в интернет-магазине или POS.
- **Последствия:**
  - Канал вызывает GCP Service `GET /certificates/next`, резервирует уникальный сертификат.
  - Канал публикует событие заказа в `All_SalesOrder` и платеж в `All_Payments` (авторизация).

## 2. Выпуск (issue) сертификата

- **Что происходит:** GCP Service получает события заказа и платежа, подтверждает выпуск сертификата.
- **Последствия:**
  - Публикация события `GiftCertificates.Stream` с `eventType=issued`, включающего канал, сумму, срок действия.
  - Публикация события `GiftCertificates.Stream` с `eventType=notification.requested` для CRM.
  - Обновление внутреннего состояния и записи аудита (внутри того же события).

## 3. Отправка CVC покупателю

- **Что происходит:** CRM получает триггер из `GiftCertificates.Stream` и отправляет CVC.
- **Последствия:**
  - CRM вызывает `GET /certificates/{id}/cvc` для получения одноразового кода.
  - После успешной доставки CRM при необходимости обновляет профиль клиента и публикует событие `All_Clients`.
  - GCP Service фиксирует результат доставкой в `GiftCertificates.Stream` (`eventType=notification.sent`/`notification.failed`).

## 4. Частичное списание (redeem.partial)

- **Что происходит:** Клиент оплачивает покупку, частично используя сертификат и частично другой способ оплаты.
- **Последствия:**
  - Канал публикует обновление заказа в `All_SalesOrder` с номером сертификата и суммой списания.
  - Канал публикует событие доплаты/списания в `All_Payments`.
  - GCP Service, сопоставив события, обновляет баланс сертификата и публикует `GiftCertificates.Stream` (`eventType=redeem.partial`, `remainingBalance`).

## 5. Полное списание (redeem.full)

- **Что происходит:** Сертификат полностью погашается.
- **Последствия:**
  - Обновление `All_SalesOrder` и `All_Payments` с суммой, равной номиналу.
  - GCP Service публикует `GiftCertificates.Stream` (`eventType=redeem.full`, `remainingBalance=0`).
  - BI фиксирует факт полного погашения, CRM может инициировать пост-коммуникации.

## 6. Возврат (refund)

- **Что происходит:** Клиент запрашивает возврат средств по сертификату.
- **Последствия:**
  - Канал инициирует возврат через `All_Payments` (refund) и отражает статус заказа в `All_SalesOrder`.
  - GCP Service обновляет состояние сертификата (например, `status=REFUNDED` или `REFUND_PENDING`) и публикует событие `GiftCertificates.Stream` (`eventType=refund.initiated`/`refund.completed`).
  - Если требуется уточнение реквизитов, в `GiftCertificates.Stream` публикуется событие `refund.pendingDetails`.

## 7. Блокировка сертификата (lock)

- **Что происходит:** Служба поддержки блокирует сертификат для проверки.
- **Последствия:**
  - HTTP-вызов `/certificates/{id}/actions/lock`.
  - GCP Service публикует `GiftCertificates.Stream` (`eventType=lock.applied`) с причиной.
  - Каналы и CRM получают уведомление и могут ограничить использование.

## 8. Разблокировка сертификата (unlock)

- **Что происходит:** Завершена проверка, сертификат снова доступен.
- **Последствия:**
  - HTTP-вызов `/certificates/{id}/actions/unlock` (FUTURE).
  - GCP Service публикует `GiftCertificates.Stream` (`eventType=lock.released`) и восстанавливает рабочий статус.

## 9. Недостаток сертификатов (issue.blocked)

- **Что происходит:** Пул предсозданных сертификатов исчерпан.
- **Последствия:**
  - Метод `GET /certificates/next` возвращает ошибку `409 CONFLICT`.
  - В `GiftCertificates.Stream` публикуется событие `issue.blocked`, BI и операторы получают уведомление.

## 10. Актуализация данных для BI

- **Что происходит:** BI подписывается на события и формирует витрины.
- **Последствия:**
  - Потребление `GiftCertificates.Stream`, `All_SalesOrder`, `All_Payments`, `All_Clients`.
  - Формирование отчётов без дополнительных HTTP-вызовов; сохранение исторических срезов.
