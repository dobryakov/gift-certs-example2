# Flowcharts

## Процесс выпусков (массовая загрузка)

- Инициатор запускает `GiftCertificateBatchLoader`, который подготавливает пакет кодов и метаданных.
- Пакет отправляется в API `POST /certificates/upload/batch`, сервис записывает сертификаты в статусе `Issued` и публикует событие `GiftCertificateState`.
- Ошибки валидации формируют DLQ/повторную отправку.

## Процесс активации при продаже

- Сервис `GiftCertificateProcessing` сопоставляет события `All_SalesOrder` и `All_Payments`.
- Перед авторизацией выполняется проверка уникальности кода: если сертификат уже реализован, фронт получает ошибку `CodeAlreadySold`.
- После подтверждения оплаты активирует сертификат, инициирует отправку SMS, обновляет состояние и публикует события.

## Процесс оплаты сертификатом

- Фронт запрашивает авторизацию, получает `authorizationId` и обновлённый доступный баланс.
- После подтверждения платежа выполняется `capture`.
- При откате операции выполняется `void`, восстанавливается баланс.

## Процесс интеграции с BI

- CDC/ETL подписывается на `GiftCertificateBI`.
- События агрегируются в витрину отчётности с атрибутами сертификата, операций и аудита.
