# Architecture Decision Records

## ADR-001: Триггер активации сертификата при частичных оплатах

- **Контекст:** В сценарии продажи подарочного сертификата заказ может оплачиваться несколькими платежами различными средствами. Каждая частичная оплата публикует событие в топик `All_Payments`. Необходимо определить, на что ориентируется `GiftCertificateProcessing`, чтобы перевести сертификат в статус `Active`, учитывая возможность непорядкового поступления сообщений.
- **Решение:**
  - Платёжный сервис расширяет событие `All_Payments` атрибутами `orderId`, `paymentVersion` (или `sequenceNumber`), `capturedAmount`, `outstandingAmount` и флагом `isOrderSettled`.
  - Kafka-топик партиционируется по `orderId`, что даёт гарантию порядка внутри партиции.
  - `GiftCertificateProcessing` хранит агрегированное состояние по `orderId`, аккумулируя суммы всех полученных платежей. Активация выполняется только когда одновременно выполнены условия:
    1. получено событие с `isOrderSettled = true`;
    2. накопленный `capturedAmount` ≥ суммы заказа (`orderGrossTotal`);
    3. не обнаружено пропусков в последовательности `paymentVersion`. При обнаружении пропуска событие буферизуется до получения недостающих версий либо истечения таймаута с переигровкой.
  - После активации состояние по `orderId` очищается, повторные события игнорируются (идемпотентность).
- **Результат:** Сервис активации не зависит от идеальной последовательности сообщений и не допускает преждевременной активации; используется событийная интеграция без дополнительных синхронных вызовов.
- **Дата:** 2025-11-08
- **Статус:** Принято
