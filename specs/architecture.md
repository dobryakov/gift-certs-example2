# Архитектура решения

## Сервисы и их ответственность

- **Сервис Процессинга Подарочных Сертификатов (GCP Service):** управление жизненным циклом сертификатов, учёт статусов, генерация CVC, взаимодействие с Orders/Payments/CRM.
- **Internet Store (ИМ):** витрина и checkout для онлайн-покупок сертификатов, подписка на уведомления о состоянии сертификата в своём канале.
- **POS:** оформление и погашение сертификатов в оффлайн точках, обмен событиями с GCP Service через Kafka.
- **Payments:** авторизация и списание средств, ручные и автоматические возвраты на исходные платёжные средства.
- **Orders:** фиксация заказов и позиций, включая покупку с использованием сертификатов.
- **CRM:** хранение клиентских данных, рассылка CVC и уведомлений, хранение истории коммуникаций.
- **BI Platform:** потребляет агрегированные данные из потоков, формирует отчётность.

## Kafka-топики

| Топик | Производитель | Потребители | Содержание |
|-------|---------------|-------------|------------|
| `All_SalesOrder` | Orders | BI, GCP Service | Состояния заказов, включая использование сертификатов |
| `All_Payments` | Payments | BI, GCP Service | Платёжные события и возвраты |
| `All_Clients` | CRM | BI, GCP Service | Клиентские данные |
| `GiftCertificates.State` | GCP Service | ИМ, POS, BI | Консолидация всех состояний сертификатов с указанием канала и атрибутов |
| `GiftCertificate.Commands` | ИМ, POS | GCP Service | Команды на выпуск, списание, возврат в своих каналах |
| `GiftCertificate.Notifications` | GCP Service | CRM | Запросы на отправку CVC или уведомлений |
| `GiftCertificate.Audit` | GCP Service | BI, Data Lake | История операций (минимальный аудит) |

Расширения BI выполняются за счёт подписки на новые топики без создания отдельного потока.

## Взаимодействия

- Все канал-специфичные операции (онлайн/оффлайн) проходят через `GiftCertificate.Commands`, что позволяет GCP Service контролировать бизнес-правила и статусные переходы.
- Ответные события публикуются в объединённый топик `GiftCertificates.State`; потребители фильтруют события по полю `channel`, что сохраняет изоляцию каналов на уровне бизнес-логики и соблюдение корпоративных ограничений.
- Для возврата GCP Service инициирует процесс в Payments, отслеживая результат через `All_Payments`.
- CRM получает запросы на уведомления и публикует результат в `All_Clients` (обновление истории) и в логах CRM.

## Обработка исключительных сценариев

- При невозможности возврата на исходный платёжный метод GCP Service автоматически генерирует команду на запрос реквизитов и сохраняет атрибут «pendingRefundDetails» в состоянии сертификата.
- Все ошибки валидируются и публикуются как события с типом `errorState` в соответствующих топиках, чтобы BI и службы поддержки могли оперативно реагировать.

## Диаграммы

- Общая схема взаимодействия сервисов и потоков приведена в файле `specs/diagrams/architecture.mmd` (Mermaid). Для визуализации используйте инструмент, поддерживающий Mermaid (например, Kroki или Mermaid CLI).

## Дополнительные замечания

- Архитектура обеспечивает слабое зацепление команд и сервисов благодаря событийной шине и позволяет масштабировать обработку сертификатов по каналам независимо.
- Консолидация состояний в `GiftCertificates.State` упрощает интеграции и BI, при этом канальное разделение обеспечивается атрибутами и политиками доступа.
