# Архитектура решения

## Сервисы и их ответственность

- **Сервис Процессинга Подарочных Сертификатов (GCP Service):** управляет жизненным циклом сертификатов, хранит пул предсозданных сертификатов, предоставляет HTTP-метод «get next cert», обогащает событиями `GiftCertificates.Stream`.
- **Internet Store (ИМ):** оформляет заказы, публикует события о заказах в `All_SalesOrder` и платежах в `All_Payments`, вызывает GCP Service для получения сертификатов.
- **POS:** выполняет те же операции в оффлайн-канале, включая запись заказов/платежей в существующие топики.
- **Payments:** публикует платежные состояния в `All_Payments` (каналы используют это хранилище, без прямых HTTP-запросов).
- **Orders:** обеспечивает консистентность и формат `All_SalesOrder`; каналы пишут в его схему.
- **CRM:** инициирует отправку CVC и коммуникаций после запроса к GCP Service.
- **BI Platform:** потребляет агрегированные данные из потоков, формирует отчётность.

## Kafka-топики

| Топик | Производитель | Потребители | Содержание |
|-------|---------------|-------------|------------|
| `All_SalesOrder` | ИМ, POS (через Orders) | BI, GCP Service | События о создании/изменении заказов, включая строки с подарочными сертификатами |
| `All_Payments` | ИМ, POS (через Payments) | BI, GCP Service | Платёжные события (авторизация, списание, возврат) |
| `All_Clients` | CRM | BI, GCP Service | Клиентские данные |
| `GiftCertificates.Stream` | GCP Service | ИМ, POS, CRM, BI | Единый поток состояний объектов `GiftCertificate` (ISSUED, PARTIALLY_REDEEMED, REDEEMED, REFUND_PENDING, REFUNDED, LOCKED, NOTIFICATION_REQUESTED, NOTIFICATION_SENT, ALERT и др.) |

Расширения BI выполняются за счёт подписки на новые топики без создания отдельного потока.

## Взаимодействия

- ИМ и POS при оформлении заказа вызывают HTTP-метод GCP Service `GET /certificates/next` для резервирования следующего сертификата, затем создают запись заказа в `All_SalesOrder` и платежное событие в `All_Payments`.
- GCP Service подписывается на `All_SalesOrder` и `All_Payments`, сопоставляет события, обновляет состояние сертификатов и публикует объект `GiftCertificate` в `GiftCertificates.Stream` с обновлённым статусом (`status`, `channel`, агрегированные атрибуты).
- CRM получает состояние `GiftCertificate` со статусом `NOTIFICATION_REQUESTED` из `GiftCertificates.Stream`, далее обращается к GCP Service (`GET /certificates/{id}/cvc`) для получения CVC и после отправки фиксирует статус `NOTIFICATION_SENT`.
- Возвраты фиксируются каналами через события `All_SalesOrder`/`All_Payments`; GCP Service реагирует на них и публикует `GiftCertificate` в статусах `REFUND_PENDING`/`REFUNDED` без дополнительных HTTP-вызовов к Payments.

## Обработка исключительных сценариев

- При отсутствии доступных сертификатов в пуле метод `get next cert` возвращает ошибку `409`, а GCP Service публикует `GiftCertificate` со статусом `ISSUE_BLOCKED` в `GiftCertificates.Stream`.
- При невозможности возврата по платёжному событию GCP Service публикует `GiftCertificate` со статусом `REFUND_PENDING` и обновляет соответствующие атрибуты; CRM или поддержка инициируют дальнейшие шаги.
- Все ошибки транслируются через `GiftCertificates.Stream` в виде состояний `ALERT`/`ERROR`, что позволяет BI и службам поддержки мониторить отклонения.

## Диаграммы

- Общая схема взаимодействия сервисов и потоков приведена в файле `specs/diagrams/architecture.mmd` (Mermaid). Для визуализации используйте инструмент, поддерживающий Mermaid (например, Kroki или Mermaid CLI).

## Дополнительные замечания

- Архитектура обеспечивает слабое зацепление команд и сервисов благодаря событийной шине и позволяет масштабировать обработку сертификатов по каналам независимо.
- Консолидация состояний в `GiftCertificates.Stream` упрощает интеграции и BI, при этом статус и канал указываются в payload для фильтрации.
- Прямые HTTP-вызовы к Payments не используются; расчёты и возвраты фиксируются исключительно через `All_Payments`.
