# Архитектура

## Компоненты

- `GiftCertificateProcessing` — мастер-сервис сертификатов; хранит состояние, управляет жизненным циклом, публикует события о состоянии и транзакциях, обеспечивает API для синхронных запросов каналов.
- `GiftCertificateBatchLoader` — служебный процесс (скрипт/интеграция) для массовой загрузки предгенерированных кодов, публикует задания в Kafka.
- `OnlineStore` — фронт интернет-магазина; использует синхронные API для проверки и списания сертификатов, слушает события для обновления UI.
- `POS` — фронт офлайн-точек; аналогично интернет-магазину вызывает API и принимает события.
- `Payments` — сервис платежей; обрабатывает платежи, уведомляет о покупках сертификатов и о комбинированных платежах.
- `Orders` — сервис заказов; отправляет события о заказах и статусах, потребляет состояния сертификатов для обогащения отчётности.
- `CRM` — сервис клиентов; инициирует маркетинговые кампании, может обогащать сертификаты связями с клиентами.
- `BI Pipeline` — коннектор в аналитику, подписан на события сертификатов.

## Kafka-топики

- `All_SalesOrder` *(существующий)* — события о заказах; используется для выявления продаж сертификатов.
- `All_Payments` *(существующий)* — события об оплатах; подтверждает факт полной оплаты подарочного сертификата.
- `All_Clients` *(существующий)* — справочная информация о клиентах.
- `GiftCertificateUpload` *(новый)* — задания на загрузку и выпуск предгенерированных сертификатов.
- `GiftCertificateState` *(новый)* — текущее состояние каждого сертификата (Issued, Active, Redeemed, PartiallyRedeemed, Refunded, Cancelled).
- `GiftCertificateTransaction` *(новый)* — события об операциях списания, возврата, аннулирования, с деталями аудита.
- `GiftCertificateBI` *(новый, агрегированный)* — поток для аналитики и отчётности, содержит агрегированную информацию (остаток, привязки к заказу/платежу/клиенту).

## Хранилища данных

- `GiftCertificateDB` — транзакционное хранилище (PostgreSQL) в сервисе процессинга; таблицы `gift_certificate`, `gift_certificate_operation`, `audit_log`.
- `GiftCertificateCache` — высокоскоростной кэш (Redis) для операций проверки баланса и авторизации.
- Существующие сервисы используют собственные БД без изменений.

## Граничные API

- HTTP API `GiftCertificateProcessing` (см. OpenAPI):
  - `POST /certificates/upload/batch` — приём файлов/пакетов кодов от загрузчиков.
  - `POST /certificates/{code}/activate` — активация по событию полной оплаты (используется внутренним сервисом).
  - `POST /certificates/{code}/authorize` — резервирование суммы перед оплатой.
  - `POST /certificates/{code}/capture` — списание при успешной оплате.
  - `POST /certificates/{code}/void` — отмена/аннулирование.
  - `GET /certificates/{code}/balance` — получение остатка.
- Event-driven контракты:
  - Подписка на `All_SalesOrder`, `All_Payments`.
  - Публикация `GiftCertificateState`, `GiftCertificateTransaction`, `GiftCertificateBI`.

## Потоки данных

- Массовая загрузка: загрузчик публикует задания → `GiftCertificateProcessing` создаёт сертификаты → публикует состояние `Issued`.
- Продажа сертификата: заказ в `Orders` + оплата в `Payments` → `GiftCertificateProcessing` активирует сертификат, публикует `GiftCertificateState(Active)` и отправляет CVC в SMS.
- Использование сертификата: фронт вызывает `authorize` → при подтверждении платежа вызывается `capture` → изменяется баланс → публикуются события состояния и транзакции.
- Возврат/аннулирование: инициирующий сервис вызывает `void`, в ответ публикуется `GiftCertificateTransaction` и обновлённое состояние.
- BI: `GiftCertificateBI` агрегирует данные из внутренних таблиц через CDC/стриминг и поставляет в аналитику.

## Аудит

- Каждая операция фиксируется в журнале `audit_log` с атрибутами: действие, идентификаторы сертификата/операции, канал, инициатор, источник события, timestamp, до/после баланс.
- Аудит-поток `GiftCertificateTransaction` обеспечивает внешнее воспроизведение действий и интеграцию с SIEM.

## Безопасность и доступ

- API требует сервисных токенов каналов `OnlineStore`, `POS`, `Payments`.
- CVC хранится только в зашифрованном виде (KMS), раскрывается однократно при отправке SMS.
- Логирование чувствительных данных производится с маскированием CVC.

## Отказоустойчивость

- Сервис масштабируется горизонтально; stateful операции обеспечиваются за счёт распределённых транзакций (PostgreSQL + optimistic locking).
- Подписчики Kafka используют consumer groups для балансировки нагрузки.
- В случае недоступности SMS-провайдера события помещаются в DLQ с повторной обработкой.
