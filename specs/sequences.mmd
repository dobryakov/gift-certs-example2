sequenceDiagram
  autonumber
  participant OS as OnlineStore
  participant PAY as Payments
  participant ORD as Orders
  participant GC as GiftCertificateProcessing
  participant SMS as SMS Gateway
  participant BI as BI Pipeline

  OS->>OS: Клиент распределяет суммы по сертификатам
  OS->>ORD: Создание заказа (Gift Certificate + allocations)
  ORD-->>GC: Event All_SalesOrder(certificateLines)
  OS->>GC: POST /certificates/{code}/authorize
  alt Код уже продан
    GC-->>OS: 409 CodeAlreadySold
  else Код свободен
    GC->>GC: Резервировать код и создать order_certificate_allocation
    GC-->>OS: AuthorizationId, резерв подтверждён
    loop Частичные оплаты
      OS->>PAY: Подтвердить оплату
      PAY-->>GC: Event All_Payments (certificateAllocations, version N, outstandingAmount > 0)
      GC->>GC: Обновить collected_amount по order_line_id
    end
    PAY-->>GC: Event All_Payments (isOrderSettled=true, outstandingAmount = 0)
    GC->>GC: Активировать сертификаты заказа
    GC-->>SMS: Отправить CVC по SMS
    GC-->>BI: Publish GiftCertificateTransaction(Activate)
    GC-->>Kafka: Publish GiftCertificateState
  end

  OS->>GC: POST /certificates/{code}/authorize (списание на покупку)
  GC-->>OS: AuthorizationId, доступный баланс
  OS->>PAY: Подтвердить оплату
  PAY->>GC: POST /certificates/{code}/capture
  GC->>GC: Списать сумму, обновить баланс
  GC-->>BI: Publish GiftCertificateTransaction(Capture)
  GC-->>Kafka: Publish GiftCertificateState

  OS->>GC: POST /certificates/{code}/refund (online возврат)
  GC->>GC: Создать refund_request, статус RefundPending
  GC-->>Kafka: Publish GiftCertificateTransaction(RefundRequested)
  GC-->>PAY: Emit RefundInitiated (All_Payments)
  PAY-->>GC: Event All_Payments(paymentStatus=RefundSettled)
  GC->>GC: Обнулить баланс, статус Refunded
  GC-->>Kafka: Publish GiftCertificateTransaction(Refund)
  GC-->>Kafka: Publish GiftCertificateState(Refunded)
