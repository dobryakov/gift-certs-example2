flowchart TD
  Start(["Начало"])
  Upload(["Загрузка пакета сертификатов"])
  Validate{Валидация пакета}
  DLQ(["Запись в DLQ и уведомление"])
  IssueNode(["Создание сертификатов Issued"])
  WaitSaleNode(["Ожидание заказа с allocations"])
  RegisterAlloc(["Фиксация certificateLines и order_certificate_allocation"])
  UniqueCheck{Код уже продан?}
  RejectNode(["Отказ CodeAlreadySold"])
  Activate(["Активация сертификатов заказа"])
  NotifySMS(["Отправка SMS с CVC"])
  Available(["Сертификат доступен для оплаты"])
  AuthorizeNode(["Резервирование суммы"])
  CaptureNode(["Списание"])
  VoidNode(["Аннулирование / возврат"])
  PaymentEvent(["All_Payments с certificateAllocations"])
  AllocationUpdate(["Обновление collected_amount"])
  AllocationCheck{Заказ полностью оплачен?}
  Publish(["Публикация событий State/Transaction"])
  BI(["Передача в BI"])
  End(["Конец"])

  Start --> Upload
  Upload --> Validate
  Validate --|Ошибка|--> DLQ
  Validate --|Успех|--> IssueNode
  IssueNode --> WaitSaleNode
  WaitSaleNode --> RegisterAlloc
  RegisterAlloc --> UniqueCheck
  UniqueCheck --|Да|--> RejectNode
  UniqueCheck --|Нет|--> AuthorizeNode
  AuthorizeNode --> PaymentEvent
  PaymentEvent --> AllocationUpdate
  AllocationUpdate --> AllocationCheck
  AllocationCheck --|Нет|--> PaymentEvent
  AllocationCheck --|Да|--> Activate
  RejectNode --> End
  Activate --> NotifySMS
  Activate --> Available
  Available -->|Authorize| AuthorizeNode
  AuthorizeNode -->|Capture| CaptureNode
  CaptureNode --> Publish
  Available -->|Void запрос| VoidNode
  VoidNode --> Publish
  Publish --> BI
  BI --> End
