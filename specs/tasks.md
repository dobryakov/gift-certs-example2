# План задач

- **Команда Сервиса Процессинга Подарочных Сертификатов**
  - **ID 1.0 — Интеграция с существующими потоками и запуск GiftCertificates.Stream**  
    **Описание:** Настроить потребление `All_SalesOrder`, `All_Payments`, `All_Clients`; создать единый поток `GiftCertificates.Stream` со схемой состояний объекта `GiftCertificate` (ISSUED, PARTIALLY_REDEEMED, REFUND_PENDING и т.д.). Обновить ACL и мониторинг.  
    **Definition of Done:** Коннекторы к существующим топикам активны, `GiftCertificates.Stream` доступен в DEV/QA/PROD, схема состояния зарегистрирована, тестовые публикации проходят.  
    **Acceptance Criteria:** Задержка обработки < 200 мс; BI и CRM успешно потребляют состояния; при нехватке сертификатов публикуется статус `ISSUE_BLOCKED`.  
    **Тест-кейсы:** Сценарии выпуска, частичного списания, возврата, блокировки; проверка фильтрации по каналу; негативный тест с пустым пулом сертификатов.  
    **Срок:** 2 недели.  
    **Роли:** Архитектор Kafka, DevOps, Backend-разработчик.

  - **ID 1.1 — Реализация ядра жизненного цикла сертификата**  
    **Описание:** Реализовать обработку событий из `All_SalesOrder`/`All_Payments`, управление статусами, генерацию CVC, хранение истории и публикацию состояний `GiftCertificate` в `GiftCertificates.Stream`.  
    **Definition of Done:** Unit-тесты > 80% покрытия, интеграционные тесты с in-memory Kafka проходят.  
    **Acceptance Criteria:** Переходы статусов соответствуют бизнес-правилам; поддержка частичного списания и возвратов; корректные состояния в `GiftCertificates.Stream`.  
    **Тест-кейсы:** Нормальный выпуск, частичное списание, полный возврат, нехватка сертификатов, блокировка.  
    **Срок:** 3 недели (после ID 1.0).  
    **Роли:** Backend-разработчики, QA, Архитектор домена.

  - **ID 1.2 — HTTP API для резервирования и поддержки**  
    **Описание:** Реализовать OpenAPI-описанные эндпоинты (`POST /certificates/next`, `GET /certificates/{id}`, `GET /certificates/{id}/cvc`, поиск, lock/unlock), добавить OAuth2, аудит вызовов.  
    **Definition of Done:** Эндпоинты задеплоены, Swagger доступен, безопасность протестирована.  
    **Acceptance Criteria:** Время ответа < 300 мс, защита от повторной выдачи CVC, корректное логирование.  
    **Тест-кейсы:** Резервирование, получение CVC, поиск, блокировка, ошибка при пустом пуле.  
    **Срок:** 2 недели (параллельно с ID 1.1 второй половины).  
    **Роли:** Backend-разработчик, QA, Security Engineer.

- **Команда Payments**
  - **ID 2.0 — Обогащение All_Payments для операций с сертификатами**  
    **Описание:** Обеспечить публикацию событий авторизации, списания, возврата с признаками сертификата; согласовать формат с GCP Service и BI.
    **Definition of Done:** События содержат ссылки на сертификаты, проходят валидацию схем, ретрансляция работает в интеграционных тестах.  
    **Acceptance Criteria:** Возврат проходит < 1 мин, ошибки логируются, поле корреляции доступно GCP Service.  
    **Тест-кейсы:** Успешный возврат, невозможность возврата, повторный запрос, дублирование события.  
    **Срок:** 2 недели (после ID 1.1 готовности схем).  
    **Роли:** Backend Payments, QA.

- **Команда Orders**
  - **ID 3.0 — Расширение модели заказа для учёта сертификатов**  
    **Описание:** Добавить ссылки на сертификаты, публикацию enriched событий, валидацию каналов.  
    **Definition of Done:** Заказы с сертификатами видны в `All_SalesOrder`, тесты обновлены.  
    **Acceptance Criteria:** Одна запись на транзакцию, корректные ссылки на сертификаты.  
    **Тест-кейсы:** Покупка с сертификатом, возврат, без сертификата.  
    **Срок:** 2 недели (параллельно с ID 1.1).  
    **Роли:** Backend Orders, Data Engineer.

- **Команда CRM**
  - **ID 4.0 — Отправка CVC через API и GiftCertificates.Stream**  
    **Описание:** Подписаться на `GiftCertificates.Stream` и обрабатывать статусы `NOTIFICATION_REQUESTED`/`NOTIFICATION_SENT`, реализовать вызов `GET /certificates/{id}/cvc`, логировать результат и обновлять `All_Clients`.  
    **Definition of Done:** Уведомления доставляются, CRM фиксирует статус и коррелирует его с состояниями `GiftCertificate`.  
    **Acceptance Criteria:** SLA доставки < 5 мин, отсутствуют повторные выдачи CVC без запроса, статусы синхронизированы с потоком.  
    **Тест-кейсы:** Успешная отправка email/SMS, сбой с повторной попыткой, ситуация `ISSUE_BLOCKED`.  
    **Срок:** 1 неделя (после ID 1.1 сообщения).  
    **Роли:** CRM-разработчик, QA.

- **Команда Internet Store**
  - **ID 5.0 — Интеграция checkout с подарочными сертификатами**  
    **Описание:** Вызвать `POST /certificates/next`, публиковать события в `All_SalesOrder`/`All_Payments`, отображать статус и остаток из `GiftCertificates.Stream`.  
    **Definition of Done:** UI обновлён, новые тесты, события публикуются.  
    **Acceptance Criteria:** Checkout без задержек, корректная информация о балансе, реакция на состояние `ISSUE_BLOCKED`.  
    **Тест-кейсы:** Покупка сертификата, покупка с сертификатом, ошибка платежа, исчерпание пула.  
    **Срок:** 3 недели (зависит от ID 1.1, ID 3.0).  
    **Роли:** Frontend, Backend, QA.

- **Команда POS**
  - **ID 6.0 — Поддержка частичного списания и возвратов**  
    **Описание:** Обновить POS для вызова `POST /certificates/next` (при необходимости), публикации событий в `All_SalesOrder`/`All_Payments`, отображения остатка и статусов из `GiftCertificates.Stream`.  
    **Definition of Done:** POS интегрирован с Kafka, UI обновлён.  
    **Acceptance Criteria:** Сценарии тестированы на пилотной точке, нет пересечения каналов, корректная работа при возвратах и статусах `LOCKED`/`REFUND_PENDING`.  
    **Тест-кейсы:** Частичное списание, полный возврат, неверный канал, блокировка сертификата.  
    **Срок:** 4 недели (после ID 1.1).  
    **Роли:** POS-разработчик, QA, Retail Ops.

- **Команда BI**
  - **ID 7.0 — Агрегация отчётности по сертификатам**  
    **Описание:** Настроить коннекторы к `GiftCertificates.Stream`, расширить витрины продаж/возвратов с учётом состояний issuance/redeem/refund и статусов блокировки.  
    **Definition of Done:** BI обновлено, отчёты публикуются ежедневно.  
    **Acceptance Criteria:** Доступность витрин 99%, данные актуальны < 30 мин, метрики по каналам совпадают с источниками.  
    **Тест-кейсы:** Сверка с Orders, контроль невалидных состояний, сценарий `ISSUE_BLOCKED`.  
    **Срок:** 2 недели (после ID 1.0).  
    **Роли:** Data Engineer, BI Analyst.

## Правила ведения

- Обновление задач выполняется по итогам каждого релиза GCP Service.
