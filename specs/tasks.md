# Список задач

- Команда сервиса GiftCertificateProcessing
  - [1] Проектирование схемы GiftCertificateDB
    - Описание задачи: разработать ERD и миграции для таблиц `gift_certificate`, `gift_certificate_operation`, `authorization_hold`, `order_certificate_allocation`, `refund_request`, `audit_log` (см. `specs/erd.md`), включая поля контроля уникальной продажи и атрибуты распределения платежей.
    - Definition of Done: миграции применены в dev/qa, ERD согласован, тестовые данные создаются автоматически.
    - Acceptance Criteria: таблицы соответствуют ERD, поддерживают основные атрибуты и связи, покрыты unit-тестами репозиториев, обеспечивают запрет повторной продажи кода.
    - Тест-кейсы (кратко):
      - Прогон миграций на чистой БД создаёт все таблицы и ограничения без ошибок.
      - Попытка повторно вставить код сертификата с активным статусом завершится нарушением ограничения уникальности.
    - Предполагаемый срок реализации: 3 недели.
    - Роли сотрудников для выполнения: архитектор данных, backend-разработчик, DevOps-инженер.
  - [2] Реализация событийных слушателей
    - Описание задачи: реализовать подписку на `All_SalesOrder` (парсинг `certificateLines`) и `All_Payments` (парсинг `certificateAllocations`) с корреляцией заказов, оплат и записей `order_certificate_allocation` (см. `specs/architecture.md`).
    - Definition of Done: логика корреляции покрыта интеграционными тестами, обеспечена идемпотентность и накопление `collected_amount`.
    - Acceptance Criteria: при получении тестового заказа и последовательности частичных оплат создаются записи `order_certificate_allocation`, корректно обновляется прогресс и после финального события активируются все сертификаты заказа с публикацией `GiftCertificateState`.
    - Тест-кейсы (кратко):
      - Интеграционный тест: последовательность событий `All_SalesOrder` + два `All_Payments` обновляет `collected_amount` и активирует сертификаты.
      - Негатив: повторная обработка того же события не создаёт дубликатов и не искажает баланс.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по интеграциям, QA-инженер.
  - [3] API авторизации и списания
    - Описание задачи: реализовать REST-эндпоинты `authorize` / `capture` / `void` / `refund` с поддержкой Redis-кэша (см. `specs/openapi.yaml`) и обработкой конфликтов `CodeAlreadySold`.
    - Definition of Done: API описан в OpenAPI, покрыт автотестами, настроен rate limiting и аудит для возвратов.
    - Acceptance Criteria: каналы `OnlineStore` и `POS` успешно проводят авторизацию, списание и возврат в QA; баланс корректно обновляется; при повторной продаже возвращается 409 `CodeAlreadySold`; возврат переводит сертификат в `RefundPending`, после события Payments — в `Refunded`.
    - Тест-кейсы (кратко):
      - API-тест: успешные вызовы `authorize` → `capture` возвращают ожидаемые статусы и балансы.
      - API-тест: вызов `refund` на сертификате с остатком создаёт `RefundPending`, повторный вызов даёт 409.
    - Предполагаемый срок реализации: 3 недели.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по безопасности, QA-инженер.
  - [4] Аудит и публикация событий
    - Описание задачи: реализовать аудит операций и публикацию событий `GiftCertificateTransaction` и `GiftCertificateBI` с включением статуса распределения (`allocation_status`), статуса возврата и идентификаторов `order_line_id` (см. `specs/architecture.md`, `specs/flows.md`).
    - Definition of Done: события логируются, доступны в Kafka, проведена проверка формата, реализован DLQ.
    - Acceptance Criteria: BI-коннектор получает тестовое событие с данными распределения и возврата, сохраняет в витрину, аудит отображает метаданные.
    - Тест-кейсы (кратко):
      - Интеграция: публикация `GiftCertificateTransaction` содержит `allocation_status`, `refundRequestId`, `orderLineId`.
      - Негатив: падение обработчика уводит сообщение в DLQ и фиксируется в логах аудита.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по данным, инженер эксплуатации.
  - [5] Оркестрация возвратов
    - Описание задачи: реализовать процесс `refund_request`, обработку статусов `RefundPending/Refunded`, интеграцию с Payments (см. `specs/architecture.md`, `specs/flows.md`).
    - Definition of Done: таблица `refund_request` и доменная логика реализованы, покрыты интеграционными тестами с моками Payments.
    - Acceptance Criteria: при возврате в QA создаётся запись `refund_request`, публикуется событие `RefundRequested`, после `RefundSettled` сертификат переходит в `Refunded`, события корректно обогащены метаданными.
    - Тест-кейсы (кратко):
      - Сквозной тест: инициированный возврат создаёт запись `refund_request`, после эмуляции `RefundSettled` статус сертификата `Refunded`.
      - Негатив: отсутствие остатка приводит к ошибке и отсутствию записи `refund_request`.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по интеграциям, QA-инженер.

- Команда сервиса GiftCertificateBatchLoader
  - [6] Инструмент массовой загрузки
    - Описание задачи: создать инструмент/скрипт для формирования и отправки пакетов сертификатов (см. `specs/flows.md`).
    - Definition of Done: инструмент документирован, поддерживает dry-run и валидацию, CI контролирует качество.
    - Acceptance Criteria: тестовый пакет в QA приводит к созданию сертификатов, ошибки формируются в отчёте.
    - Тест-кейсы (кратко):
      - Unit: dry-run на валидном файле возвращает список сертификатов без записи в БД.
      - Интеграция: загрузка файла с ошибкой формата попадает в отчёт ошибок и не создаёт сертификаты.
    - Предполагаемый срок реализации: 1 неделя.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по данным, технический писатель.

- Команда сервиса OnlineStore
  - [7] Интеграция с API сертификатов
    - Описание задачи: добавить в фронт вызовы `authorize` / `capture` / `refund` и отображение баланса (см. `specs/sequences.md`, `specs/openapi.yaml`).
    - Definition of Done: фронт покрыт e2e-тестами, UI отображает остаток и прогресс возврата, обрабатывает ошибки.
    - Acceptance Criteria: пользователь может применить сертификат, запросить возврат остатка через UI и видеть статусы; при попытке повторной продажи отображается ошибка бизнес-уровня.
    - Тест-кейсы (кратко):
      - E2E: пользователь оплачивает заказ сертификатом и видит обновлённый баланс.
      - UI-тест: инициирование возврата отображает статус `RefundPending`, после коллбэка — `Refunded`.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: frontend-разработчик, UX-дизайнер, QA-инженер.

- Команда сервиса POS
  - [8] Интеграция POS с API
    - Описание задачи: реализовать сценарии проверки баланса, списания и возврата в POS (см. `specs/sequences.md`).
    - Definition of Done: требования согласованы, тесты на кассовом окружении, инструкции для продавцов, предусмотрен запрос реквизитов при альтернативном возврате.
    - Acceptance Criteria: кассир проводит оплату сертификатом, получает чек с остатком, может инициировать возврат с выдачей чека на сумму остатка; при повторной продаже кассир видит отказ `CodeAlreadySold`.
    - Тест-кейсы (кратко):
      - Интеграционный тест POS: успешная продажа и печать чека с остатком.
      - Сценарий возврата: кассир инициирует refund, чек фиксирует сумму возврата, при альтернативном методе появляется форма ввода реквизитов.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: инженер POS-платформы, аналитик бизнес-процессов, тренер по обучению персонала.

- Команда сервиса Payments
  - [9] Обогащение событий оплат
    - Описание задачи: добавить к событиям `All_Payments` атрибуты, указывающие на покупку сертификата и операции возврата (см. `specs/architecture.md`), включая `paymentVersion`, `capturedAmount`, `outstandingAmount`, `isOrderSettled`, массив `certificateAllocations[]` (`orderLineId`, `allocatedAmount`, `currency`), `paymentStatus` (RefundInitiated/RefundSettled) и `refundDetails`.
    - Definition of Done: изменения задокументированы, обратная совместимость сохранена, реализована схема в контрактных тестах.
    - Acceptance Criteria: `GiftCertificateProcessing` корректно накапливает суммы по `orderLineId`, активирует сертификаты только после события с `isOrderSettled=true`, частичные платежи отображаются в QA, возврат переводится из `RefundPending` в `Refunded` после события `RefundSettled`.
    - Тест-кейсы (кратко):
      - Контрактный тест: событие `All_Payments` содержит новые поля и валидируется потребителем.
      - Сквозной тест: публикация `RefundSettled` приводит к смене статуса сертификата на `Refunded`.
    - Предполагаемый срок реализации: 1 неделя.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по интеграциям, QA-инженер.

- Команда сервиса BI Pipeline
  - [10] Коннектор GiftCertificateBI
    - Описание задачи: настроить потребление топика `GiftCertificateBI` и загрузку в витрину (см. `specs/architecture.md`, `specs/flow.mmd`).
    - Definition of Done: коннектор деплоен, мониторится, схемы документированы.
    - Acceptance Criteria: BI получает демо-набор событий и строит отчёт остатков.
    - Тест-кейсы (кратко):
      - Интеграционный тест: потребление события `GiftCertificateBI` приводит к записи в витрину с корректными полями.
      - Негатив: при недоступности витрины коннектор уходит в ретраи и фиксирует алерт.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: инженер по данным, аналитик BI, DevOps-инженер.

- Команда сервиса SMS Gateway
  - [11] Отправка CVC по SMS
    - Описание задачи: настроить интеграцию с существующим SMS-шлюзом для доставки CVC (см. `specs/flows.md`).
    - Definition of Done: конфигурация хранится безопасно, предусмотрен повтор отправки.
    - Acceptance Criteria: при покупке сертификата в QA клиент получает SMS с CVC.
    - Тест-кейсы (кратко):
      - Интеграционный тест: отправка SMS при активации сертификата завершается успехом и логируется.
      - Негатив: симуляция сбоя провайдера переводит сообщение в очередь повторов и вызывает уведомление.
    - Предполагаемый срок реализации: 1 неделя.
    - Роли сотрудников для выполнения: инженер по интеграциям, специалист по информационной безопасности, QA-инженер.

- Команда сервиса Orders
  - [12] Расширение модели заказа для сертификатов
    - Описание задачи: добавить к позициям заказа атрибуты `certificateSku`, `plannedDenomination`, `intendedRecipient`, `orderLineId` и обеспечить хранение предпочтений покупателя (см. `specs/clarification.md`, `specs/architecture.md`).
    - Definition of Done: миграции применены, API Orders возвращает новые атрибуты, обновлены контрактные тесты.
    - Acceptance Criteria: фронты и интеграции получают обогащённые позиции сертификатов, данные корректно сохраняются и доступны в аналитике.
    - Тест-кейсы (кратко):
      - API-тест: запрос заказа возвращает `certificateLines` с новыми атрибутами.
      - Негатив: попытка создать заказ без `plannedDenomination` отклоняется валидатором.
    - Предполагаемый срок реализации: 2 недели.
    - Роли сотрудников для выполнения: архитектор данных, backend-разработчик, QA-инженер.
  - [13] Публикация certificateLines в `All_SalesOrder`
    - Описание задачи: дополнить событие `All_SalesOrder` секцией `certificateLines[]` с суммами и получателями сертификатов (см. `specs/architecture.md`, `specs/sequences.md`).
    - Definition of Done: схема события обновлена, описана документацией, проведены consumer-тесты.
    - Acceptance Criteria: `GiftCertificateProcessing` получает событие с `certificateLines`, создаёт записи `order_certificate_allocation`, QA-интеграция подтверждает корректную корреляцию.
    - Тест-кейсы (кратко):
      - Контрактный тест: новое событие `All_SalesOrder` валидируется потребителями.
      - Интеграционный тест: событие с несколькими `certificateLines` корректно создаёт соответствующие записи в процессинге.
    - Предполагаемый срок реализации: 1 неделя.
    - Роли сотрудников для выполнения: backend-разработчик, инженер по интеграциям, QA-инженер.
